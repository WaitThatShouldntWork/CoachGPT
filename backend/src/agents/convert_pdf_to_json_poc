# Need to add to requirements.txt file
import io
import fitz
import json
import requests

# Required to bypass being blocked by websites that restrict access
# Shouldn't be necessary when implemented in code, same for GET request
headers = {"""'User-Agent': 'Mozilla/5.0 (X11; Windows; Windows x86_64)
           AppleWebKit/537.36 (KHTML, like Gecko) 
           Chrome/103.0.5060.114 Safari/537.36'"""}

url = 'https://www.natwest.com/content/dam/natwest/personal/current-accounts/documents/Independent-survey-resultsf.pdf'

response = requests.get(url=url, headers=headers, timeout=120)
# Loads the PDF into an In-Memory Object
on_fly_mem_obj = io.BytesIO(response.content)

with fitz.open("pdf", on_fly_mem_obj) as pdf_document:
    pdf_text = {}

    for count, page in enumerate(pdf_document, start=1):
        all_infos = page.get_text("dict", sort=True)
        blocks = all_infos["blocks"]
        filtered_blocks = [block for block in blocks if not block.get("image")]
        page_text = ""
        for block in filtered_blocks:
            try:
                text = block["lines"][0]['spans'][0]['text']
                page_text += text + " "
            except KeyError:
                ("No image in this block")
        pdf_text[f"Page {count}"] = page_text.strip()

    pdf_json = json.dumps(pdf_text, indent=4)

print(pdf_json)
